<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clara - AI Insurance Assistant</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117; color: #e6edf3; height: 100vh; overflow: hidden;
    }
    .container { display: flex; flex-direction: column; height: 100vh; max-width: 768px; margin: 0 auto; }
    .header { padding: 20px; text-align: center; border-bottom: 1px solid #30363d; }
    .logo { font-size: 24px; font-weight: 500; background: linear-gradient(45deg, #4285f4, #34a853, #fbbc04, #ea4335); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
    .subtitle { color: #8b949e; font-size: 14px; margin-top: 4px; }
    #auth-section { text-align:center; margin: 20px 0; padding: 0 20px; }
    #login-btn, #logout-btn { padding: 8px 18px; border: 0; border-radius: 6px; background: #238636; color: white; font-weight: 500; margin: 0 6px; cursor: pointer; transition: background-color 0.2s; }
    #login-btn:disabled { background: #555; cursor: not-allowed; }
    #logout-btn { background: #d73a49; }
    #contenido-privado { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    .message { display: flex; gap: 12px; max-width: 100%; align-items: flex-end; }
    .avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; }
    .user-avatar { background: #238636; color: white; }
    .ai-avatar { background: linear-gradient(45deg, #4285f4, #34a853); color: white; }
    .message-content { flex-shrink: 1; background: #161b22; padding: 16px; border-radius: 12px; border: 1px solid #30363d; line-height: 1.5; word-wrap: break-word; }
    .user-message { justify-content: flex-end; }
    .user-message .message-content { background: #0969da; color: white; }
    .input-container { padding: 20px; border-top: 1px solid #30363d; }
    .upload-container { padding: 0 20px 20px 20px; border-top: 1px solid #30363d; }
    .upload-wrapper { background: #21262d; border: 2px dashed #30363d; border-radius: 12px; padding: 20px; text-align: center; transition: border-color 0.2s; cursor: pointer; }
    .upload-wrapper:hover { border-color: #4285f4; }
    .input-wrapper { position: relative; display: flex; align-items: flex-end; background: #21262d; border: 1px solid #30363d; border-radius: 24px; overflow: hidden; transition: border-color 0.2s; }
    .input-wrapper:focus-within { border-color: #4285f4; }
    .chat-input { flex: 1; padding: 14px 20px; background: transparent; border: none; color: #e6edf3; font-size: 16px; resize: none; outline: none; max-height: 120px; font-family: inherit; }
    .send-button { margin: 6px; padding: 10px; background: #4285f4; border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; flex-shrink: 0; }
    .send-button:hover { background: #3367d6; }
    .typing { opacity: 0.7; font-style: italic; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">Clara</div>
      <div class="subtitle">Tu consultora experta en seguros y fianzas</div>
    </div>

    <div id="auth-section">
      <form id="login-form" style="display:none;">
        <input type="email" id="email" placeholder="Tu correo electrónico" required style="padding:8px; border-radius:4px; border:1px solid #30363d; color:#222; min-width: 220px;">
        <button id="login-btn" type="submit">Ingresar por correo</button>
      </form>
      <button id="logout-btn" style="display:none;">Cerrar Sesión</button>
      <div id="msg" style="margin-top:10px; color:#34a853;"></div>
    </div>

    <div id="contenido-privado">
      <div class="upload-container">
        <div class="upload-wrapper" id="upload-wrapper">
          <input type="file" id="file-input" accept=".pdf,.txt,.doc,.docx" style="display: none;">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="#4285f4" style="margin-bottom: 10px;">
            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
          </svg>
          <div style="color: #e6edf3; font-size: 16px; margin-bottom: 5px;">Cargar documentos para entrenar a Clara</div>
          <div style="color: #8b949e; font-size: 14px;">PDF, TXT, DOC, DOCX - Max 10MB</div>
          <div id="selected-file" style="color:#8b949e; margin-top:8px;"></div>
          <button id="upload-btn" class="login-btn" style="margin-top:12px; display:none;" type="button">Cargar y procesar</button>
          <div id="upload-status" style="margin-top:8px; color:#34a853;"></div>
        </div>
      </div>
      <div class="chat-container" id="chat-container">
        <div class="message">
          <div class="avatar ai-avatar">C</div>
          <div class="message-content">
            ¡Hola! Soy Clara. Para comenzar, por favor inicia sesión. Una vez dentro, podrás hacerme preguntas o subir documentos para que los analice.
          </div>
        </div>
      </div>
      <div class="input-container">
        <div class="input-wrapper">
          <textarea
            class="chat-input"
            id="user-input"
            placeholder="Inicia sesión para comenzar a chatear..."
            rows="1"
            disabled
          ></textarea>
          <button class="send-button" id="send-btn" type="button" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div> </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- SUPABASE SETUP ---
      const supabaseUrl = 'https://ygtguphvjoijfuiontai.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlndGd1cGh2am9pamZ1aW9udGFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NDgyMTQsImV4cCI6MjA2NDEyNDIxNH0.nc4X9pAURriYdKjlzWX38CLxjM5TtxxNCJSximcM3NI';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // --- N8N WEBHOOK URLs ---
      const API_URL = 'https://mamutlabs.app.n8n.cloud/webhook/chat';
      const UPLOAD_URL = 'https://mamutlabs.app.n8n.cloud/webhook/upload';

      // --- DOM ELEMENTS ---
      const loginForm = document.getElementById('login-form');
      const emailInput = document.getElementById('email');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const contenidoPrivado = document.getElementById('contenido-privado');
      const authSection = document.getElementById('auth-section');
      const msgDiv = document.getElementById('msg');
      const userInput = document.getElementById('user-input');
      const sendBtn = document.getElementById('send-btn');
      const chatContainer = document.getElementById('chat-container');
      const fileInput = document.getElementById('file-input');
      const uploadBtn = document.getElementById('upload-btn');
      const selectedFileDiv = document.getElementById('selected-file');
      const uploadStatus = document.getElementById('upload-status');
      const uploadWrapper = document.getElementById('upload-wrapper');

      // --- APP STATE ---
      let currentSession = null;
      let selectedFile = null;
      let isSending = false;

      // --- AUTHENTICATION ---

      /**
       * Updates the UI based on the user's authentication state.
       * @param {object|null} session - The Supabase session object, or null if logged out.
       */
      const toggleAuthUI = (session) => {
        currentSession = session; // Store session globally
        if (session) {
          // User is logged in
          authSection.style.display = 'block';
          loginForm.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          contenidoPrivado.style.display = 'flex'; // Use flex to enable child flex properties
          msgDiv.textContent = '';
          userInput.disabled = false;
          sendBtn.disabled = false;
          userInput.placeholder = 'Pregúntame sobre seguros, fianzas o sube documentos...';
          // Clear initial message and welcome the user
          const initialMessage = chatContainer.querySelector('.message');
          if (initialMessage && initialMessage.innerText.includes('Para comenzar, por favor inicia sesión')) {
            initialMessage.querySelector('.message-content').innerHTML = `¡Hola de nuevo! Soy Clara. ¿En qué puedo ayudarte hoy?`;
          }
        } else {
          // User is logged out
          authSection.style.display = 'block';
          loginForm.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          contenidoPrivado.style.display = 'none';
          msgDiv.textContent = '';
          userInput.disabled = true;
          sendBtn.disabled = true;
          userInput.placeholder = 'Inicia sesión para comenzar a chatear...';
        }
      };

      // Listen for authentication state changes (login, logout)
      supabase.auth.onAuthStateChange((_event, session) => {
        toggleAuthUI(session);
      });

      // Check for an existing session when the page loads
      supabase.auth.getSession().then(({ data: { session } }) => {
        toggleAuthUI(session);
      }).catch(error => {
        console.error("Error getting session:", error);
        toggleAuthUI(null);
      });

      // Handle email login
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        msgDiv.style.color = '#34a853';
        msgDiv.textContent = 'Enviando enlace de acceso a tu correo...';
        loginBtn.disabled = true;
        const email = emailInput.value;

        const { error } = await supabase.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: window.location.origin // Redirect to the base URL
          }
        });

        if (error) {
          msgDiv.style.color = '#ea4335';
          msgDiv.textContent = 'Error: ' + error.message;
        } else {
          msgDiv.style.color = '#34a853';
          msgDiv.textContent = '¡Revisa tu bandeja de entrada para ingresar!';
        }
        loginBtn.disabled = false;
      });

      // Handle logout
      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        // onAuthStateChange will handle the UI update
      });

      // --- CHAT & FILE UPLOAD LOGIC ---

      /**
       * Sends a message to the backend API.
       */
     const MCP_API_URL = 'https://mamutlabs.app.n8n.cloud/mcp/webhook/sse';

const sendMessage = async () => {
  if (isSending || !currentSession) return;

  const message = userInput.value.trim();
  if (!message) return;

  isSending = true;
  addMessageToUI(message, true);
  userInput.value = '';
  userInput.style.height = 'auto';
  const typingId = addTypingIndicator();

  try {
    const response = await fetch(MCP_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: message,
        userId: currentSession.user.id,
        timestamp: new Date().toISOString()
      })
    });

    const responseText = await response.text();
    removeTypingIndicator(typingId);
    addMessageToUI(responseText || 'No he podido procesar tu solicitud.', false);
  } catch (error) {
    console.error("Chat error:", error);
    removeTypingIndicator(typingId);
    addMessageToUI('Hubo un error de conexión. Por favor, intenta de nuevo.', false);
  } finally {
    isSending = false;
  }
};     

      /**
       * Uploads a document to the backend.
       * @param {File} file - The file to upload.
       */
      const uploadDocument = async (file) => {
          if (!file || !currentSession) return;

          uploadStatus.style.color = "#fbbc04";
          uploadStatus.textContent = 'Procesando y entrenando a Clara...';
          uploadBtn.disabled = true;

          const formData = new FormData();
          formData.append('file', file);
          formData.append('filename', file.name);
          formData.append('user_id', currentSession.user.id); // Use the REAL user ID

          try {
              const response = await fetch(UPLOAD_URL, {
                  method: 'POST',
                  body: formData
              });
              if (response.ok) {
                  uploadStatus.style.color = "#34a853";
                  uploadStatus.textContent = `✅ Documento "${file.name}" cargado. Ya puedes preguntarme sobre su contenido.`;
                  // Reset file input state
                  selectedFile = null;
                  fileInput.value = '';
                  selectedFileDiv.textContent = '';
                  uploadBtn.style.display = 'none';
              } else {
                  const errorData = await response.json();
                  uploadStatus.style.color = "#ea4335";
                  uploadStatus.textContent = `❌ Error al procesar: ${errorData.message || 'Intenta de nuevo.'}`;
              }
          } catch (error) {
              console.error("Upload error:", error);
              uploadStatus.style.color = "#ea4335";
              uploadStatus.textContent = '❌ Error de conexión al subir el archivo.';
          } finally {
              uploadBtn.disabled = false;
          }
      };


      // --- UI HELPERS & EVENT LISTENERS ---

      // Auto-resize textarea
      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });

      // Send on Enter key
      userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      // Send button click
      sendBtn.addEventListener('click', sendMessage);

      // Trigger file input
      uploadWrapper.addEventListener('click', (e) => {
          if (e.target !== uploadBtn) {
              fileInput.click();
          }
      });
      
      // Handle file selection
      fileInput.addEventListener('change', (e) => {
        selectedFile = e.target.files[0] || null;
        if (selectedFile) {
          selectedFileDiv.textContent = `Archivo: ${selectedFile.name}`;
          uploadBtn.style.display = 'block';
          uploadStatus.textContent = '';
        } else {
          selectedFileDiv.textContent = '';
          uploadBtn.style.display = 'none';
        }
      });
      
      // Handle file upload button click
      uploadBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent uploadWrapper's click event
          if (selectedFile) {
            uploadDocument(selectedFile);
          }
      });

      /**
       * Adds a message bubble to the chat container.
       * @param {string} text - The message content.
       * @param {boolean} isUser - True if the message is from the user.
       */
      function addMessageToUI(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message' + (isUser ? ' user-message' : '');
        messageDiv.innerHTML = `
          <div class="avatar ${isUser ? 'user-avatar' : 'ai-avatar'}">${isUser ? 'U' : 'C'}</div>
          <div class="message-content">${text.replace(/\n/g, '<br>')}</div>
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function addTypingIndicator() {
        const id = 'typing-' + Date.now();
        const typingDiv = document.createElement('div');
        typingDiv.id = id;
        typingDiv.className = 'message';
        typingDiv.innerHTML = `
          <div class="avatar ai-avatar">C</div>
          <div class="message-content typing">Clara está escribiendo...</div>
        `;
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return id;
      }

      function removeTypingIndicator(id) {
        const element = document.getElementById(id);
        if (element) element.remove();
      }
    });
  </script>
</body>
</html>
